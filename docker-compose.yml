version: '3'

services:
  ingress:
    image: traefik:1.7-alpine 
    container_name: ingress
    command: -c /etc/traefik/traefik.toml
    ports:
      # traefik also binds port 80 on startup
      - "8080:8080"
    volumes:
      - ./conf/traefik/traefik.toml:/etc/traefik/traefik.toml
      - /var/run/docker.sock:/var/run/docker.sock
  db:
    image: postgres
    container_name: db
    environment: 
      - "POSTGRES_USER=www_user"
      - "POSTGRES_PASSWORD=www_passwrd"
      - "POSTGRES_DB=maindb"
      - "POSTGRES_DATA=/pgdata"
    volumes:
      - pgdata:/pgdata
    ports: 
      - "5432"
  roachdb:
    image: cockroachdb/cockroach
    container_name: roachdb
    command: start --insecure --listen-addr=auxdb:26257
    volumes:
      - roachdata:/cockroach
    ports: 
      - "26257"
  message-bus:
    image: "rabbitmq:3.7-management-alpine"
    container_name: message-bus
    volumes:
      - ./conf/rabbitmq/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf
      - rabbitdata:/var/lib/rabbitmq
    ports:
      - "15672" # Management UI
      - "5672"
  web:
    build: .
    container_name: web
    command: start
    labels:
      - "traefik.enable=true"
    volumes:
      - .:/usr/src/app
    ports:
      - "8000"
    depends_on:
      - db
      - message-bus

volumes: 
  pgdata:
  rabbitdata:
  roachdata: